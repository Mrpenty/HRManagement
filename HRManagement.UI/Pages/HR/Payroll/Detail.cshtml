@page "/HR/Payroll/Detail"
@{
    ViewData["Title"] = "Payroll Detail & Update";
    Layout = "_HRLayout";
}
<div class="container mt-4">
    <h2>Payroll Detail & Update</h2>
    <div class="row mb-3">
        <div class="col-md-6">
            <form id="salaryForm">
                <input type="hidden" id="salaryId" />
                <dl class="row">
                    <dt class="col-sm-4">Employee</dt>
                    <dd class="col-sm-8" id="employeeName"></dd>
                </dl>
                <div class="mb-3">
                    <label class="form-label">Base Salary</label>
                    <input id="baseSalary" class="form-control" type="number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Allowances</label>
                    <input id="allowances" class="form-control" type="number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Bonus</label>
                    <input id="bonus" class="form-control" type="number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Deduction</label>
                    <input id="deduction" class="form-control" type="number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Tax</label>
                    <input id="tax" class="form-control" type="number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Net Salary</label>
                    <input id="netSalary" class="form-control" type="number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Salary Period</label>
                    <input id="salaryPeriod" type="month" class="form-control" />
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="/HR/PayrollManagement" class="btn btn-secondary ms-2">Back</a>
            </form>
        </div>
        <div class="col-md-6">
            <h5>Salary Adjustments</h5>
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Reason</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="adjustmentsTable">
                    <!-- JS render adjustments here -->
                </tbody>
            </table>
            <div class="mt-3">
                <h6>Add Bonus/Deduction</h6>
                <form id="adjustForm" onsubmit="event.preventDefault(); submitAdjustment();">
                    <div class="mb-2">
                        <select class="form-select" id="adjustType">
                            <option value="Bonus">Bonus</option>
                            <option value="Deduction">Deduction</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <input type="number" class="form-control" id="adjustAmount" placeholder="Amount" />
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="adjustReason" placeholder="Reason" />
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts {
<script>
    const apiBase = "https://localhost:7201/api";
    const urlParams = new URLSearchParams(window.location.search);
    const salaryId = urlParams.get('id');
    let currentUserId = 0;

    async function loadSalary() {
        const res = await fetch(`${apiBase}/Salary/${salaryId}`);
        if (!res.ok) { alert('Salary not found'); return; }
        const salary = await res.json();
        document.getElementById('salaryId').value = salary.salaryID;
        document.getElementById('baseSalary').value = salary.baseSalary;
        document.getElementById('allowances').value = salary.allowances;
        document.getElementById('bonus').value = salary.bonus;
        document.getElementById('deduction').value = salary.deduction;
        document.getElementById('tax').value = salary.tax;
        document.getElementById('netSalary').value = salary.netSalary;
        document.getElementById('salaryPeriod').value = salary.salaryPeriod.substring(0, 7);
        currentUserId = salary.userID;
        // Load user
        const userRes = await fetch(`${apiBase}/User/${salary.userID}`);
        if (userRes.ok) {
            const user = await userRes.json();
            document.getElementById('employeeName').innerText = user.firstName + ' ' + user.lastName;
        }
    }

    async function loadAdjustments() {
        const res = await fetch(`${apiBase}/Salary/${salaryId}/adjustments`);
        if (!res.ok) return;
        const adjustments = await res.json();
        const tbody = document.getElementById('adjustmentsTable');
        tbody.innerHTML = '';
        adjustments.forEach(adj => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${adj.type}</td>
                            <td>${adj.amount}</td>
                            <td>${adj.reason}</td>
                            <td>${new Date(adj.createdAt).toLocaleString()}</td>`;
            tbody.appendChild(tr);
        });
    }

    document.getElementById('salaryForm').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            salaryID: parseInt(document.getElementById('salaryId').value),
            baseSalary: parseFloat(document.getElementById('baseSalary').value),
            allowances: parseFloat(document.getElementById('allowances').value),
            bonus: parseFloat(document.getElementById('bonus').value),
            deduction: parseFloat(document.getElementById('deduction').value),
            tax: parseFloat(document.getElementById('tax').value),
            netSalary: parseFloat(document.getElementById('netSalary').value),
            salaryPeriod: document.getElementById('salaryPeriod').value + '-01',
            userID: currentUserId
        };
        const res = await fetch(`${apiBase}/Salary/${salaryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            alert('Update success!');
            await loadSalary();
            await loadAdjustments();
        } else {
            alert('Update failed!');
        }
    };

    async function submitAdjustment() {
        const type = document.getElementById('adjustType').value;
        const amount = parseFloat(document.getElementById('adjustAmount').value);
        const reason = document.getElementById('adjustReason').value;
        if (!amount || !reason) {
            alert('Amount and reason are required!');
            return;
        }
        let url = '';
        if (type === 'Bonus') url = `${apiBase}/Salary/${salaryId}/bonus`;
        else url = `${apiBase}/Salary/${salaryId}/deduction`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, reason })
        });
        if (res.ok) {
            alert('Adjustment added!');
            await loadAdjustments();
        } else {
            alert('Add adjustment failed!');
        }
    }

    // Initial load
    loadSalary();
    loadAdjustments();
</script>
} 