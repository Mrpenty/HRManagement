@page
@model HRManagement.UI.Pages.Auth.LoginModel
@{
    ViewData["Title"] = "Login";
    Layout = null; // We want a custom layout for the login page
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - HRManagement.UI</title>
    <link rel="stylesheet" href="~/css/bootstrap.min.css" />
    <style>
        body {
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .login-container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .login-container h1 {
            font-family: 'Times New Roman', Times, serif;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .form-control:focus {
            box-shadow: none;
            border-color: #007bff;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>

    <div class="login-container">
        <h1>Log in</h1>
        <p>Need an account? <a href="/Auth/Register">Create an account</a></p>
        <form id="loginForm">
            <div class="mb-3">
                <label for="email" class="form-label">Username or Email</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-block">Log in</button>
            </div>
            <div id="login-error" class="text-danger mt-2"></div>
        </form>
        <div class="text-center mt-3">
            <a href="#">Forgot username?</a> &middot; <a href="#">Forgot password?</a>
        </div>
    </div>

    <script src="~/js/core/jquery-3.7.1.min.js"></script>
    <script>
        // Function to decode JWT
        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        $('#loginForm').on('submit', function (e) {
            e.preventDefault();
            $('#login-error').text('');

            var loginData = {
                email: $('#email').val(),
                password: $('#password').val()
            };

            $.ajax({
                url: 'https://localhost:7201/api/Auth/login', // Make sure this port is correct for your API
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(loginData),
                success: function (response) {
                    // Store the token in a cookie that expires in 1 day
                    var d = new Date();
                    d.setTime(d.getTime() + (1*24*60*60*1000));
                    var expires = "expires="+ d.toUTCString();
                    document.cookie = "accessToken=" + response.token + ";" + expires + ";path=/";

                    const decodedToken = parseJwt(response.token);
                    if (decodedToken) {
                        // Check for a return URL and redirect if it exists
                        const returnUrl = new URLSearchParams(window.location.search).get('ReturnUrl');
                        if (returnUrl) {
                            window.location.href = returnUrl;
                        } else {
                            const role = decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
                            if (role === 'Employee') {
                                window.location.href = '/Employees/Dashboard';
                            } else {
                                window.location.href = '/';
                            }
                        }
                    } else {
                        $('#login-error').text('Invalid token received. Please check login credentials.');
                    }
                },
                error: function (xhr, status, error) {
                    var errorMessage = 'An error occurred.';
                    if (xhr.responseText) {
                        try {
                             var response = JSON.parse(xhr.responseText);
                             errorMessage = response.message || xhr.responseText;
                        } catch(e) {
                             errorMessage = xhr.responseText;
                        }
                    }
                     $('#login-error').text(errorMessage);
                }
            });
        });
    </script>
</body>
</html> 